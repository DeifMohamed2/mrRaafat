<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <%- include('./partials/head.ejs') %>
  <style>
    .quiz-detail-container {
      padding: 20px;
    }
    
    .quiz-header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 30px;
    }
    
    .quiz-title {
      font-size: 2rem;
      margin-bottom: 10px;
    }
    
    .quiz-meta {
      display: flex;
      gap: 30px;
      flex-wrap: wrap;
    }
    
    .quiz-meta-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      text-align: center;
    }
    
    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: var(--primary-color);
      margin-bottom: 5px;
    }
    
    .stat-label {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }
    
    .score-distribution {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    
    .distribution-bars {
      display: flex;
      gap: 10px;
      align-items: end;
      height: 100px;
      margin-top: 15px;
    }
    
    .distribution-bar {
      flex: 1;
      background: var(--primary-color);
      border-radius: 5px 5px 0 0;
      position: relative;
      min-height: 20px;
    }
    
    .distribution-label {
      position: absolute;
      bottom: -25px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.8rem;
      color: var(--text-secondary);
    }
    
    .top-performers {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    
    .performer-card {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      background: #f8f9fa;
    }
    
    .performer-rank {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: white;
    }
    
    .rank-1 { background: #ffd700; }
    .rank-2 { background: #c0c0c0; }
    .rank-3 { background: #cd7f32; }
    
    .students-table {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .table-header {
      background: var(--primary-color);
      color: white;
      padding: 15px 20px;
      font-weight: bold;
    }
    
    .student-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr;
      padding: 15px 20px;
      border-bottom: 1px solid #eee;
      align-items: center;
    }
    
    .student-row:hover {
      background: #f8f9fa;
    }
    
    .student-row:last-child {
      border-bottom: none;
    }
    
    .status-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: bold;
    }
    
    .status-completed { background: #d4edda; color: #155724; }
    .status-in-progress { background: #fff3cd; color: #856404; }
    .status-not-attempted { background: #f8d7da; color: #721c24; }
    
    .actions-bar {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .btn-export {
      background: var(--success-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-export:hover {
      background: #28a745;
    }
  </style>
</head>
<body>
  <div class="teacher-container">
    <!-- Sidebar -->
    <%- include('./partials/nav.ejs') %>
    
    <!-- Main Content -->
    <main class="teacher-main">
      <!-- Header -->
      <%- include('./partials/top.ejs') %>
      
      <!-- Content -->
      <div class="teacher-content">
        <div class="quiz-detail-container">
          <!-- Quiz Header -->
          <div class="quiz-header">
            <h1 class="quiz-title"><%= quiz.quizName %></h1>
            <div class="quiz-meta">
              <div class="quiz-meta-item">
                <i class="fas fa-layer-group"></i>
                <span><%= chapter ? chapter.chapterName : 'غير محدد' %></span>
              </div>
              <div class="quiz-meta-item">
                <i class="fas fa-users"></i>
                <span><%= quiz.Grade === 'Grade1' ? 'الصف الأول الثانوي' : quiz.Grade === 'Grade2' ? 'الصف الثاني الثانوي' : 'الصف الثالث الثانوي' %></span>
              </div>
              <div class="quiz-meta-item">
                <i class="fas fa-question-circle"></i>
                <span><%= quiz.questionsToShow || quiz.questionsCount %> من <%= quiz.Questions ? quiz.Questions.length : quiz.questionsCount %> أسئلة</span>
              </div>
              <div class="quiz-meta-item">
                <i class="fas fa-clock"></i>
                <span><%= quiz.timeOfQuiz %> دقيقة</span>
              </div>
              <div class="quiz-meta-item">
                <i class="fas fa-toggle-<%= quiz.isQuizActive ? 'on' : 'off' %>"></i>
                <span><%= quiz.isQuizActive ? 'نشط' : 'غير نشط' %></span>
              </div>
            </div>
          </div>
          
          <!-- Actions Bar -->
          <div class="actions-bar">
            <a href="/teacher/quizzes/<%= quiz._id %>/edit" class="btn btn-primary">
              <i class="fas fa-edit"></i>
              تعديل الاختبار
            </a>
            <a href="/teacher/quizzes/<%= quiz._id %>/results" class="btn btn-outline">
              <i class="fas fa-chart-bar"></i>
              عرض النتائج التفصيلية
            </a>
            <a href="/teacher/quizzes/<%= quiz._id %>/export" class="btn-export">
              <i class="fas fa-download"></i>
              تصدير النتائج
            </a>
          </div>
          
          <!-- Statistics Grid -->
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value"><%= stats.totalStudents %></div>
              <div class="stat-label">إجمالي الطلاب</div>
            </div>
            <div class="stat-card">
              <div class="stat-value"><%= stats.attemptedStudents %></div>
              <div class="stat-label">الطلاب المحاولون</div>
            </div>
            <div class="stat-card">
              <div class="stat-value"><%= stats.completedStudents %></div>
              <div class="stat-label">الطلاب المكملون</div>
            </div>
            <div class="stat-card">
              <div class="stat-value"><%= stats.inProgressStudents %></div>
              <div class="stat-label">قيد التنفيذ</div>
            </div>
            <div class="stat-card">
              <div class="stat-value"><%= stats.notAttemptedStudents %></div>
              <div class="stat-label">لم يحاولوا</div>
            </div>
            <div class="stat-card">
              <div class="stat-value"><%= stats.averageScoreDisplay %></div>
              <div class="stat-label">متوسط الدرجات</div>
            </div>
          </div>
          
          <!-- Score Distribution -->
          <div class="score-distribution">
            <h3>توزيع الدرجات</h3>
            <div class="distribution-bars">
              <div class="distribution-bar" style="height: <%= scoreDistribution.excellent > 0 ? (scoreDistribution.excellent / Math.max(...Object.values(scoreDistribution))) * 80 : 0 %>%">
                <div class="distribution-label">ممتاز (90+)</div>
              </div>
              <div class="distribution-bar" style="height: <%= scoreDistribution.good > 0 ? (scoreDistribution.good / Math.max(...Object.values(scoreDistribution))) * 80 : 0 %>%">
                <div class="distribution-label">جيد (80-89)</div>
              </div>
              <div class="distribution-bar" style="height: <%= scoreDistribution.average > 0 ? (scoreDistribution.average / Math.max(...Object.values(scoreDistribution))) * 80 : 0 %>%">
                <div class="distribution-label">متوسط (70-79)</div>
              </div>
              <div class="distribution-bar" style="height: <%= scoreDistribution.belowAverage > 0 ? (scoreDistribution.belowAverage / Math.max(...Object.values(scoreDistribution))) * 80 : 0 %>%">
                <div class="distribution-label">ضعيف (60-69)</div>
              </div>
              <div class="distribution-bar" style="height: <%= scoreDistribution.failed > 0 ? (scoreDistribution.failed / Math.max(...Object.values(scoreDistribution))) * 80 : 0 %>%">
                <div class="distribution-label">راسب (<60)</div>
              </div>
            </div>
            <div style="margin-top: 40px; display: flex; justify-content: space-around;">
              <div><strong>ممتاز:</strong> <%= scoreDistribution.excellent %> طالب</div>
              <div><strong>جيد:</strong> <%= scoreDistribution.good %> طالب</div>
              <div><strong>متوسط:</strong> <%= scoreDistribution.average %> طالب</div>
              <div><strong>ضعيف:</strong> <%= scoreDistribution.belowAverage %> طالب</div>
              <div><strong>راسب:</strong> <%= scoreDistribution.failed %> طالب</div>
            </div>
          </div>
          
          <!-- Top Performers -->
          <div class="top-performers">
            <h3>أفضل الأداء</h3>
            <% if (topPerformers.length > 0) { %>
              <% topPerformers.forEach((performer, index) => { %>
                <div class="performer-card">
                  <div class="performer-rank rank-<%= index + 1 %>">
                    <%= index + 1 %>
                  </div>
                  <div style="flex: 1;">
                    <div style="font-weight: bold;"><%= performer.studentName %></div>
                    <div style="color: var(--text-secondary); font-size: 0.9rem;">كود: <%= performer.studentCode %></div>
                  </div>
                  <div style="font-weight: bold; color: var(--primary-color);">
                    <%= performer.quizScoreDisplay %>
                  </div>
                </div>
              <% }); %>
            <% } else { %>
              <p style="text-align: center; color: var(--text-secondary);">لا توجد نتائج متاحة بعد</p>
            <% } %>
          </div>
          
          <!-- Students Table -->
          <div class="students-table">
            <div class="table-header">
              قائمة الطلاب
            </div>
            <div class="student-row" style="background: #f8f9fa; font-weight: bold;">
              <div>اسم الطالب</div>
              <div>كود الطالب</div>
              <div>الصف</div>
              <div>رقم الهاتف</div>
              <div>هاتف الوالد</div>
              <div>الحالة</div>
              <div>الدرجة</div>
              <div>وقت الانتهاء</div>
            </div>
            <% students.forEach(function(student) { %>
              <div class="student-row">
                <div><%= student.studentName %></div>
                <div><%= student.studentCode %></div>
                <div><%= student.grade %></div>
                <div><%= student.phoneNumber || '-' %></div>
                <div><%= student.parentPhoneNumber || '-' %></div>
                <div>
                  <% if (student.quizInProgress) { %>
                    <span class="status-badge status-in-progress">قيد التنفيذ</span>
                  <% } else if (student.quizAttempted) { %>
                    <span class="status-badge status-completed">مكتمل</span>
                  <% } else { %>
                    <span class="status-badge status-not-attempted">لم يحاول</span>
                  <% } %>
                </div>
                <div>
                  <% if (student.quizAttempted && !student.quizInProgress) { %>
                    <strong style="color: var(--primary-color);"><%= student.quizScoreDisplay %></strong>
                  <% } else { %>
                    -
                  <% } %>
                </div>
                <div>
                  <% if (student.quizEndTime) { %>
                    <%= new Date(student.quizEndTime).toLocaleString('ar-EG') %>
                  <% } else { %>
                    -
                  <% } %>
                </div>
              </div>
            <% }); %>
            
            <% if (students.length === 0) { %>
              <div class="student-row">
                <div colspan="8" style="text-align: center; color: var(--text-secondary);">
                  لا توجد بيانات متاحة
                </div>
              </div>
            <% } %>
          </div>
          
          <!-- Pagination -->
          <% if (totalPages > 1) { %>
            <div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 20px; padding: 20px;">
              <% if (currentPage > 1) { %>
                <a href="?page=<%= currentPage - 1 %>" class="btn btn-outline">
                  <i class="fas fa-chevron-right"></i>
                  السابق
                </a>
              <% } %>
              
              <span style="color: var(--text-secondary);">
                صفحة <%= currentPage %> من <%= totalPages %>
              </span>
              
              <% if (currentPage < totalPages) { %>
                <a href="?page=<%= currentPage + 1 %>" class="btn btn-outline">
                  التالي
                  <i class="fas fa-chevron-left"></i>
                </a>
              <% } %>
            </div>
          <% } %>
        </div>
      </div>
    </main>
  </div>
  
  <script>
    // Add any interactive functionality here
    document.addEventListener('DOMContentLoaded', function() {
      // Auto-refresh every 30 seconds to get latest data
      setInterval(() => {
        // You can add auto-refresh logic here if needed
      }, 30000);
    });
  </script>
</body>
</html> 